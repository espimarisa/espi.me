/**
 * @file Configuration file for Eleventy.
 * @license zlib
 */

// @ts-check

import path from "node:path";
import externalLinks from "@aloskutov/eleventy-plugin-external-links";
import browserslist from "browserslist";
import { compress } from "eleventy-plugin-compress";
import htmlmin from "html-minifier-next";
import { browserslistToTargets, bundle } from "lightningcss";

// Configures browserslist targets.
const targets = browserslistToTargets(browserslist("> 0.2% and not dead"));

/**
 * Configures Eleventy.
 * @param {(import("@11ty/eleventy/UserConfig").default)} eleventyConfig
 * @see https://www.11ty.dev/docs/config/
 */

export default async function (eleventyConfig) {
	// Configures data, input, and output directories.
	eleventyConfig.setInputDirectory("./src");
	eleventyConfig.setOutputDirectory("./_site");
	eleventyConfig.setDataDirectory("_data");
	eleventyConfig.setIncludesDirectory("_includes");
	eleventyConfig.setLayoutsDirectory("_layouts");

	// Copy static files in /public to the root output directory.
	eleventyConfig.addPassthroughCopy({ "./public": "/" });

	// Automatically append target=_blank and rel attributes to external links.
	eleventyConfig.addPlugin(externalLinks);

	// Automatically compress contents with brotli.
	eleventyConfig.addPlugin(compress, {
		algorithm: "brotli",
		enabled: true,
	});

	// Configures the Nunjucks engine.
	eleventyConfig.setNunjucksEnvironmentOptions({
		throwOnUndefined: true,
	});

	// Process CSS with LightningCSS.
	eleventyConfig.addTemplateFormats(["css"]);
	eleventyConfig.addExtension("css", {
		outputFileExtension: "css",

		// Compiles the content.
		compile: async (_content, input) => {
			// Parses the content; ignore files starting with _.
			const parsed = path.parse(input);
			if (parsed.name.startsWith("_")) {
				return;
			}

			return async () => {
				// Bundles the content together.
				const { code } = bundle({
					filename: input,
					minify: true,
					sourceMap: false,
					targets: targets,
				});

				return code;
			};
		},
	});

	// Minifies HTML contents.
	eleventyConfig.addTransform("htmlmin", function (content) {
		// Only minify pages processed as HTML templates.
		if ((this.page.outputPath || "").endsWith(".html")) {
			const minified = htmlmin.minify(content, {
				collapseBooleanAttributes: true,
				collapseInlineTagWhitespace: true,
				collapseWhitespace: true,
				conservativeCollapse: true,
				decodeEntities: true,
				includeAutoGeneratedTags: false,
				minifyCSS: true,
				minifyJS: true,
				minifyURLs: true,
				noNewlinesBeforeTagClose: true,
				preventAttributesEscaping: true,
				processConditionalComments: true,
				removeAttributeQuotes: true,
				removeComments: true,
				removeEmptyAttributes: true,
				removeOptionalTags: true,
				removeRedundantAttributes: true,
				removeScriptTypeAttributes: true,
				removeStyleLinkTypeAttributes: true,
				sortAttributes: true,
				sortClassName: true,
				trimCustomFragments: true,
				useShortDoctype: true,
			});

			return minified;
		}

		return content;
	});
}
